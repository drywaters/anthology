<section class="book-details" [formGroup]="form">
    <div class="book-details-header">
        <p class="section-eyebrow">Book details</p>
        <h3>Edition specifics</h3>
    </div>

    <div class="book-grid">
        <mat-form-field appearance="fill">
            <mat-label>Reading status</mat-label>
            <mat-select formControlName="readingStatus" (valueChange)="onStatusChange($event)">
                <mat-option *ngFor="let option of bookStatusOptions" [value]="option.value">
                    {{ option.label }}
                </mat-option>
            </mat-select>
            <mat-hint>Track whether you have read or started this book.</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill" *ngIf="isReadStatus">
            <mat-label>Date finished</mat-label>
            <input matInput [matDatepicker]="finishedPicker" formControlName="readAt" />
            <mat-datepicker-toggle matIconSuffix [for]="finishedPicker"></mat-datepicker-toggle>
            <mat-datepicker #finishedPicker></mat-datepicker>
            <mat-error *ngIf="form.get('readAt')?.hasError('required')">
                Finish date is required when marking a book as read.
            </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill" *ngIf="isReadingStatus">
            <mat-label>Current page</mat-label>
            <input matInput formControlName="currentPage" type="number" min="0" />
            <button
                mat-icon-button
                matSuffix
                type="button"
                (click)="clearCurrentPage()"
                aria-label="Clear current page"
                *ngIf="form.get('currentPage')?.value || form.get('currentPage')?.value === 0"
            >
                <mat-icon>close</mat-icon>
            </button>
            <mat-hint *ngIf="form.get('pageCount')?.value as total"
                >Out of {{ total }} total pages.</mat-hint
            >
            <mat-error *ngIf="form.get('currentPage')?.hasError('min')">
                Current page cannot be negative.
            </mat-error>
            <mat-error *ngIf="form.get('currentPage')?.hasError('maxPages')">
                Current page cannot exceed the total page count.
            </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
            <mat-label>Number of pages</mat-label>
            <input matInput formControlName="pageCount" type="number" min="1" />
            <button
                mat-icon-button
                matSuffix
                type="button"
                (click)="clearPageCount()"
                aria-label="Clear page count"
            >
                <mat-icon>close</mat-icon>
            </button>
            <mat-hint>Total printed pages for the edition you own.</mat-hint>
            <mat-error *ngIf="form.get('pageCount')?.hasError('min')"
                >Use at least one page.</mat-error
            >
        </mat-form-field>

        <mat-form-field appearance="fill">
            <mat-label>EAN / ISBN13</mat-label>
            <input matInput formControlName="isbn13" maxlength="20" />
            <mat-hint>13-digit ISBN printed near the barcode.</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
            <mat-label>ISBN-10</mat-label>
            <input matInput formControlName="isbn10" maxlength="20" />
            <mat-hint>10-digit identifier code.</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
            <mat-label>Format</mat-label>
            <mat-select formControlName="format">
                <mat-option *ngFor="let option of formatOptions" [value]="option.value">
                    {{ option.label }}
                </mat-option>
            </mat-select>
            <mat-hint>Physical format of this edition.</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
            <mat-label>Genre</mat-label>
            <mat-select formControlName="genre">
                <mat-option *ngFor="let option of genreOptions" [value]="option.value">
                    {{ option.label }}
                </mat-option>
            </mat-select>
            <mat-hint>Primary category for this book.</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
            <mat-label>Your rating</mat-label>
            <input matInput formControlName="rating" type="number" min="1" max="10" />
            <button
                mat-icon-button
                matSuffix
                type="button"
                (click)="clearRating()"
                aria-label="Clear rating"
                *ngIf="form.get('rating')?.value"
            >
                <mat-icon>close</mat-icon>
            </button>
            <mat-hint>Personal enjoyment rating (1â€“10).</mat-hint>
            <mat-error *ngIf="form.get('rating')?.hasError('min')"
                >Rating must be at least 1.</mat-error
            >
            <mat-error *ngIf="form.get('rating')?.hasError('max')"
                >Rating cannot exceed 10.</mat-error
            >
        </mat-form-field>

        <mat-form-field appearance="fill">
            <mat-label>Retail price (USD)</mat-label>
            <input matInput formControlName="retailPriceUsd" type="number" min="0" step="0.01" />
            <button
                mat-icon-button
                matSuffix
                type="button"
                (click)="clearRetailPrice()"
                aria-label="Clear retail price"
                *ngIf="form.get('retailPriceUsd')?.value"
            >
                <mat-icon>close</mat-icon>
            </button>
            <mat-hint>List price in US dollars.</mat-hint>
            <mat-error *ngIf="form.get('retailPriceUsd')?.hasError('min')"
                >Price cannot be negative.</mat-error
            >
        </mat-form-field>

        <mat-form-field appearance="fill">
            <mat-label>Google Volume ID</mat-label>
            <input matInput formControlName="googleVolumeId" />
            <mat-hint>Used to refresh metadata from Google Books.</mat-hint>
        </mat-form-field>
    </div>

    <div class="description-section">
        <div class="description-heading">
            <h4>Description</h4>
        </div>
        <mat-form-field appearance="fill" class="description-field">
            <mat-label>Book description</mat-label>
            <textarea matInput rows="5" formControlName="description" maxlength="2000"></textarea>
            <mat-hint align="end">{{ form.get('description')?.value?.length || 0 }}/2000</mat-hint>
        </mat-form-field>
    </div>

    <div class="series-section">
        <div class="series-heading">
            <div class="series-toggle-header">
                <h4>Series</h4>
                <mat-slide-toggle
                    [checked]="seriesExpanded()"
                    (change)="toggleSeriesSection()"
                    aria-label="Toggle series information"
                >
                    <span class="toggle-label">
                        {{ seriesExpanded() ? '' : 'Part of a series?' }}
                    </span>
                </mat-slide-toggle>
            </div>
        </div>
        @if (seriesExpanded()) {
            <div class="series-grid">
                <mat-form-field appearance="fill" class="series-name-field">
                    <mat-label>Series name</mat-label>
                    <input
                        matInput
                        formControlName="seriesName"
                        maxlength="200"
                        [matAutocomplete]="seriesAutocomplete"
                    />
                    <mat-autocomplete #seriesAutocomplete="matAutocomplete">
                        <mat-option *ngIf="loadingSeriesNames()" disabled>
                            Loading series...
                        </mat-option>
                        <mat-option *ngFor="let name of filteredSeriesNames()" [value]="name">
                            {{ name }}
                        </mat-option>
                        <mat-option
                            *ngIf="
                                !loadingSeriesNames() &&
                                filteredSeriesNames().length === 0 &&
                                form.get('seriesName')?.value
                            "
                            disabled
                        >
                            No matching series (new series will be created)
                        </mat-option>
                    </mat-autocomplete>
                    <button
                        mat-icon-button
                        matSuffix
                        type="button"
                        (click)="clearSeriesName()"
                        aria-label="Clear series name"
                        *ngIf="form.get('seriesName')?.value"
                    >
                        <mat-icon>close</mat-icon>
                    </button>
                    <mat-hint>Name of the book series (e.g., "Harry Potter").</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="fill">
                    <mat-label>Volume number</mat-label>
                    <input matInput formControlName="volumeNumber" type="number" min="1" />
                    <button
                        mat-icon-button
                        matSuffix
                        type="button"
                        (click)="clearVolumeNumber()"
                        aria-label="Clear volume number"
                        *ngIf="form.get('volumeNumber')?.value"
                    >
                        <mat-icon>close</mat-icon>
                    </button>
                    <mat-hint>This book's position in the series.</mat-hint>
                    <mat-error *ngIf="form.get('volumeNumber')?.hasError('min')">
                        Volume number must be at least 1.
                    </mat-error>
                    <mat-error *ngIf="form.get('volumeNumber')?.hasError('exceedsTotal')">
                        Volume number cannot exceed total volumes.
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill">
                    <mat-label>Total volumes</mat-label>
                    <input matInput formControlName="totalVolumes" type="number" min="1" />
                    <button
                        mat-icon-button
                        matSuffix
                        type="button"
                        (click)="clearTotalVolumes()"
                        aria-label="Clear total volumes"
                        *ngIf="form.get('totalVolumes')?.value"
                    >
                        <mat-icon>close</mat-icon>
                    </button>
                    <mat-hint>Total number of volumes in the series (if known).</mat-hint>
                    <mat-error *ngIf="form.get('totalVolumes')?.hasError('min')">
                        Total volumes must be at least 1.
                    </mat-error>
                </mat-form-field>
            </div>
        }
    </div>
</section>
