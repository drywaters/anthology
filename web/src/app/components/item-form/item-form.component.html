<form [formGroup]="form" (ngSubmit)="submit()" class="item-form" novalidate>
    <mat-form-field appearance="fill">
        <mat-label>Title</mat-label>
        <input matInput formControlName="title" maxlength="120" required />
        <mat-error *ngIf="form.get('title')?.hasError('required')">Title is required.</mat-error>
        <mat-error *ngIf="form.get('title')?.hasError('maxlength')">Keep titles under 120 characters.</mat-error>
    </mat-form-field>

    <mat-form-field appearance="fill">
        <mat-label>Creator</mat-label>
        <input matInput formControlName="creator" maxlength="120" />
        <mat-hint>Author, developer, or primary artist.</mat-hint>
    </mat-form-field>

    <mat-form-field appearance="fill">
        <mat-label>Type</mat-label>
        <mat-select formControlName="itemType" required>
            <mat-option *ngFor="let option of itemTypeOptions" [value]="option[0]">
                {{ option[1] }}
            </mat-option>
        </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill">
        <mat-label>Release year</mat-label>
        <input matInput formControlName="releaseYear" type="number" min="0" />
        <button mat-icon-button matSuffix type="button" (click)="clearReleaseYear()" aria-label="Clear release year">
          <mat-icon>close</mat-icon>
        </button>
    </mat-form-field>

    <section class="book-details" *ngIf="isBook">
        <div class="book-details-header">
            <p class="section-eyebrow">Book details</p>
            <h3>Edition specifics</h3>
        </div>

        <div class="book-grid">
            <mat-form-field appearance="fill">
                <mat-label>Reading status</mat-label>
                <mat-select formControlName="readingStatus" (valueChange)="onStatusChange($event)">
                    <mat-option *ngFor="let option of bookStatusOptions" [value]="option.value">
                        {{ option.label }}
                    </mat-option>
                </mat-select>
                <mat-hint>Track whether you have read or started this book.</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngIf="isReadStatus">
                <mat-label>Date finished</mat-label>
                <input matInput [matDatepicker]="finishedPicker" formControlName="readAt" />
                <mat-datepicker-toggle matIconSuffix [for]="finishedPicker"></mat-datepicker-toggle>
                <mat-datepicker #finishedPicker></mat-datepicker>
                <mat-error *ngIf="form.get('readAt')?.hasError('required')">
                    Finish date is required when marking a book as read.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngIf="isReadingStatus">
                <mat-label>Current page</mat-label>
                <input matInput formControlName="currentPage" type="number" min="0" />
                <button
                    mat-icon-button
                    matSuffix
                    type="button"
                    (click)="clearCurrentPage()"
                    aria-label="Clear current page"
                    *ngIf="form.get('currentPage')?.value || form.get('currentPage')?.value === 0"
                >
                    <mat-icon>close</mat-icon>
                </button>
                <mat-hint *ngIf="form.get('pageCount')?.value as total">Out of {{ total }} total pages.</mat-hint>
                <mat-error *ngIf="form.get('currentPage')?.hasError('min')">
                    Current page cannot be negative.
                </mat-error>
                <mat-error *ngIf="form.get('currentPage')?.hasError('maxPages')">
                    Current page cannot exceed the total page count.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill">
                <mat-label>Number of pages</mat-label>
                <input matInput formControlName="pageCount" type="number" min="1" />
                <button mat-icon-button matSuffix type="button" (click)="clearPageCount()" aria-label="Clear page count">
                    <mat-icon>close</mat-icon>
                </button>
                <mat-hint>Total printed pages for the edition you own.</mat-hint>
                <mat-error *ngIf="form.get('pageCount')?.hasError('min')">Use at least one page.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill">
                <mat-label>EAN / ISBN13</mat-label>
                <input matInput formControlName="isbn13" maxlength="20" />
                <mat-hint>13-digit ISBN printed near the barcode.</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="fill">
                <mat-label>ISBN-10</mat-label>
                <input matInput formControlName="isbn10" maxlength="20" />
                <mat-hint>10-digit identifier code.</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="fill">
                <mat-label>Format</mat-label>
                <mat-select formControlName="format">
                    <mat-option *ngFor="let option of formatOptions" [value]="option.value">
                        {{ option.label }}
                    </mat-option>
                </mat-select>
                <mat-hint>Physical format of this edition.</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="fill">
                <mat-label>Genre</mat-label>
                <mat-select formControlName="genre">
                    <mat-option *ngFor="let option of genreOptions" [value]="option.value">
                        {{ option.label }}
                    </mat-option>
                </mat-select>
                <mat-hint>Primary category for this book.</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="fill">
                <mat-label>Your rating</mat-label>
                <input matInput formControlName="rating" type="number" min="1" max="10" />
                <button
                    mat-icon-button
                    matSuffix
                    type="button"
                    (click)="clearRating()"
                    aria-label="Clear rating"
                    *ngIf="form.get('rating')?.value"
                >
                    <mat-icon>close</mat-icon>
                </button>
                <mat-hint>Personal enjoyment rating (1–10).</mat-hint>
                <mat-error *ngIf="form.get('rating')?.hasError('min')">Rating must be at least 1.</mat-error>
                <mat-error *ngIf="form.get('rating')?.hasError('max')">Rating cannot exceed 10.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill">
                <mat-label>Retail price (USD)</mat-label>
                <input matInput formControlName="retailPriceUsd" type="number" min="0" step="0.01" />
                <button
                    mat-icon-button
                    matSuffix
                    type="button"
                    (click)="clearRetailPrice()"
                    aria-label="Clear retail price"
                    *ngIf="form.get('retailPriceUsd')?.value"
                >
                    <mat-icon>close</mat-icon>
                </button>
                <mat-hint>List price in US dollars.</mat-hint>
                <mat-error *ngIf="form.get('retailPriceUsd')?.hasError('min')">Price cannot be negative.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill">
                <mat-label>Google Volume ID</mat-label>
                <input matInput formControlName="googleVolumeId" />
                <mat-hint>Used to refresh metadata from Google Books.</mat-hint>
            </mat-form-field>
        </div>

        <div class="description-section">
            <div class="description-heading">
                <h4>Description</h4>
                <span class="description-highlight" aria-hidden="true"></span>
            </div>
            <mat-form-field appearance="fill" class="description-field">
                <mat-label>Book description</mat-label>
                <textarea matInput rows="5" formControlName="description" maxlength="2000"></textarea>
                <mat-hint align="end">{{ form.get('description')?.value?.length || 0 }}/2000</mat-hint>
            </mat-form-field>
        </div>

    </section>

    <section class="game-details" *ngIf="isGame">
        <div class="game-details-header">
            <p class="section-eyebrow">Game details</p>
            <h3>Game specifics</h3>
        </div>

        <div class="game-grid">
            <mat-form-field appearance="fill">
                <mat-label>Platform</mat-label>
                <input matInput formControlName="platform" maxlength="200" />
                <mat-hint>Console, system, or format (e.g., Nintendo Switch, PlayStation 5, PC, Board Game)</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="fill">
                <mat-label>Age group</mat-label>
                <input matInput formControlName="ageGroup" maxlength="100" />
                <mat-hint>Suggested age rating (e.g., Teen, Everyone 10+, Adults)</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="fill">
                <mat-label>Number of players</mat-label>
                <input matInput formControlName="playerCount" maxlength="100" />
                <mat-hint>Typical player count (e.g., 1–4 players, Solo, Multiplayer)</mat-hint>
            </mat-form-field>
        </div>

        <div class="description-section">
            <div class="description-heading">
                <h4>Description</h4>
                <span class="description-highlight description-highlight--game" aria-hidden="true"></span>
            </div>
            <mat-form-field appearance="fill" class="description-field">
                <mat-label>Game description</mat-label>
                <textarea matInput rows="5" formControlName="description" maxlength="2000"></textarea>
                <mat-hint align="end">{{ form.get('description')?.value?.length || 0 }}/2000</mat-hint>
            </mat-form-field>
        </div>
    </section>

    <div class="cover-section">
        <div class="cover-preview" [class.cover-preview--empty]="!form.get('coverImage')?.value">
            <img *ngIf="form.get('coverImage')?.value" [src]="form.get('coverImage')?.value" alt="Cover preview" />
            <div *ngIf="!form.get('coverImage')?.value" class="cover-placeholder">
                <mat-icon aria-hidden="true">photo</mat-icon>
                <span>No cover added yet</span>
            </div>
        </div>

        <div class="cover-fields">
            <div class="cover-header">
                <h4>Cover image</h4>
                <p class="cover-hint">Use a JPG/PNG under 500KB. Upload a file or paste an image link.</p>
            </div>

            <mat-form-field appearance="fill" class="cover-image-field">
                <mat-label>Cover image URL or data URI</mat-label>
                <input matInput formControlName="coverImage" (input)="clearCoverError()" />
                <button
                    mat-icon-button
                    matSuffix
                    type="button"
                    *ngIf="form.get('coverImage')?.value"
                    (click)="clearCoverImage()"
                    aria-label="Remove cover image"
                >
                    <mat-icon>close</mat-icon>
                </button>
                <mat-hint>Links stay as-is; uploaded images are stored as thumbnails.</mat-hint>
            </mat-form-field>

            <div class="cover-actions">
                <button mat-stroked-button type="button" (click)="openCoverFilePicker()">Upload image</button>
                <button mat-button type="button" (click)="clearCoverImage()" [disabled]="!form.get('coverImage')?.value">
                    Remove
                </button>
                <input
                    #coverInput
                    type="file"
                    accept="image/*"
                    class="sr-only"
                    (change)="handleCoverFileChange($event)"
                />
            </div>

            <div class="cover-error" *ngIf="coverImageError">{{ coverImageError }}</div>
        </div>
    </div>

    <mat-form-field appearance="fill">
        <mat-label>Notes</mat-label>
        <textarea matInput rows="4" formControlName="notes" maxlength="500"></textarea>
        <mat-hint align="end">{{ form.get('notes')?.value?.length || 0 }}/500</mat-hint>
    </mat-form-field>

    <div class="form-actions">
        <button
            mat-flat-button
            color="warn"
            type="button"
            *ngIf="mode === 'edit'"
            class="form-actions__delete"
            (click)="deleteRequested.emit()"
            [disabled]="busy || resyncing"
        >
            Delete item
        </button>
        <button
            mat-stroked-button
            type="button"
            *ngIf="mode === 'edit' && isBook"
            (click)="requestResync()"
            [disabled]="busy || resyncing"
        >
            {{ resyncing ? 'Syncing...' : 'Re-sync from Google Books' }}
        </button>
        <button mat-stroked-button type="button" (click)="cancelled.emit()" [disabled]="busy || resyncing">
           Cancel
        </button>
        <button mat-flat-button color="primary" type="submit" [disabled]="busy || resyncing">
            {{ mode === 'create' ? 'Add to collection' : 'Save changes' }}
        </button>
    </div>
</form>
