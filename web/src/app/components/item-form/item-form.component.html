<form [formGroup]="form" (ngSubmit)="submit()" class="item-form" novalidate>
    <mat-form-field appearance="fill">
        <mat-label>Title</mat-label>
        <input matInput formControlName="title" maxlength="120" required />
        <mat-error *ngIf="form.get('title')?.hasError('required')">Title is required.</mat-error>
        <mat-error *ngIf="form.get('title')?.hasError('maxlength')">Keep titles under 120 characters.</mat-error>
    </mat-form-field>

    <mat-form-field appearance="fill">
        <mat-label>Creator</mat-label>
        <input matInput formControlName="creator" maxlength="120" />
        <mat-hint>Author, developer, or primary artist.</mat-hint>
    </mat-form-field>

    <mat-form-field appearance="fill">
        <mat-label>Type</mat-label>
        <mat-select formControlName="itemType" required>
            <mat-option *ngFor="let option of itemTypeOptions" [value]="option[0]">
                {{ option[1] }}
            </mat-option>
        </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill">
        <mat-label>Release year</mat-label>
        <input matInput formControlName="releaseYear" type="number" min="0" />
        <button mat-icon-button matSuffix type="button" (click)="clearReleaseYear()" aria-label="Clear release year">
          <mat-icon>close</mat-icon>
        </button>
    </mat-form-field>

    <section class="book-details" *ngIf="isBook">
        <div class="book-details-header">
            <p class="section-eyebrow">Book details</p>
            <h3>Edition specifics</h3>
        </div>

        <div class="book-grid">
            <mat-form-field appearance="fill">
                <mat-label>Reading status</mat-label>
                <mat-select formControlName="readingStatus" (valueChange)="onStatusChange($event)">
                    <mat-option *ngFor="let option of bookStatusOptions" [value]="option[0]">
                        {{ option[1] }}
                    </mat-option>
                </mat-select>
                <mat-hint>Track whether you have read or started this book.</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngIf="isReadStatus">
                <mat-label>Date finished</mat-label>
                <input matInput formControlName="readAt" type="date" />
                <mat-error *ngIf="form.get('readAt')?.hasError('required')">
                    Finish date is required when marking a book as read.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill">
                <mat-label>Number of pages</mat-label>
                <input matInput formControlName="pageCount" type="number" min="1" />
                <button mat-icon-button matSuffix type="button" (click)="clearPageCount()" aria-label="Clear page count">
                    <mat-icon>close</mat-icon>
                </button>
                <mat-hint>Total printed pages for the edition you own.</mat-hint>
                <mat-error *ngIf="form.get('pageCount')?.hasError('min')">Use at least one page.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill">
                <mat-label>EAN / ISBN13</mat-label>
                <input matInput formControlName="isbn13" maxlength="20" />
                <mat-hint>13-digit ISBN printed near the barcode.</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="fill">
                <mat-label>UPC / ISBN10</mat-label>
                <input matInput formControlName="isbn10" maxlength="20" />
                <mat-hint>10-digit code for older editions.</mat-hint>
            </mat-form-field>
        </div>

        <div class="description-section">
            <div class="description-heading">
                <h4>Description</h4>
                <span class="description-highlight" aria-hidden="true"></span>
            </div>
            <mat-form-field appearance="fill" class="description-field">
                <mat-label>Book description</mat-label>
                <textarea matInput rows="5" formControlName="description" maxlength="2000"></textarea>
                <mat-hint align="end">{{ form.get('description')?.value?.length || 0 }}/2000</mat-hint>
            </mat-form-field>
        </div>

    </section>

    <div class="cover-section">
        <div class="cover-preview" [class.cover-preview--empty]="!form.get('coverImage')?.value">
            <img *ngIf="form.get('coverImage')?.value" [src]="form.get('coverImage')?.value" alt="Cover preview" />
            <div *ngIf="!form.get('coverImage')?.value" class="cover-placeholder">
                <mat-icon aria-hidden="true">photo</mat-icon>
                <span>No cover added yet</span>
            </div>
        </div>

        <div class="cover-fields">
            <div class="cover-header">
                <h4>Cover image</h4>
                <p class="cover-hint">Use a JPG/PNG under 500KB. Upload a file or paste an image link.</p>
            </div>

            <mat-form-field appearance="fill" class="cover-image-field">
                <mat-label>Cover image URL or data URI</mat-label>
                <input matInput formControlName="coverImage" (input)="clearCoverError()" />
                <button
                    mat-icon-button
                    matSuffix
                    type="button"
                    *ngIf="form.get('coverImage')?.value"
                    (click)="clearCoverImage()"
                    aria-label="Remove cover image"
                >
                    <mat-icon>close</mat-icon>
                </button>
                <mat-hint>Links stay as-is; uploaded images are stored as thumbnails.</mat-hint>
            </mat-form-field>

            <div class="cover-actions">
                <button mat-stroked-button type="button" (click)="openCoverFilePicker()">Upload image</button>
                <button mat-button type="button" (click)="clearCoverImage()" [disabled]="!form.get('coverImage')?.value">
                    Remove
                </button>
                <input
                    #coverInput
                    type="file"
                    accept="image/*"
                    class="sr-only"
                    (change)="handleCoverFileChange($event)"
                />
            </div>

            <div class="cover-error" *ngIf="coverImageError">{{ coverImageError }}</div>
        </div>
    </div>

    <mat-form-field appearance="fill">
        <mat-label>Notes</mat-label>
        <textarea matInput rows="4" formControlName="notes" maxlength="500"></textarea>
        <mat-hint align="end">{{ form.get('notes')?.value?.length || 0 }}/500</mat-hint>
    </mat-form-field>

    <div class="form-actions">
        <button
            mat-flat-button
            color="warn"
            type="button"
            *ngIf="mode === 'edit'"
            class="form-actions__delete"
            (click)="deleteRequested.emit()"
            [disabled]="busy"
        >
            Delete item
        </button>
        <button mat-stroked-button type="button" (click)="cancelled.emit()" [disabled]="busy">
           Cancel
        </button>
        <button mat-flat-button color="primary" type="submit" [disabled]="busy">
            {{ mode === 'create' ? 'Add to collection' : 'Save changes' }}
        </button>
    </div>
</form>
