<section class="add-item-page">
    <mat-card>
        <mat-card-header>
            <mat-card-title>Add a new item</mat-card-title>
            <mat-card-subtitle>Search for metadata or enter details manually.</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            <mat-tab-group
                [selectedIndex]="selectedTab()"
                (selectedIndexChange)="handleTabChange($event)"
            >
                <mat-tab label="Search">
                    <div class="tab-body search-tab">
                        @if (seriesPrefill(); as prefill) {
                            <div class="series-prefill-notice">
                                <mat-icon aria-hidden="true">library_books</mat-icon>
                                <span>
                                    Adding to series: <strong>{{ prefill.seriesName }}</strong>
                                    @if (prefill.volumeNumber !== null) {
                                        <span> (Volume {{ prefill.volumeNumber }}) </span>
                                    }
                                </span>
                                <button
                                    mat-icon-button
                                    type="button"
                                    (click)="clearSeriesPrefill()"
                                    aria-label="Clear series prefill"
                                >
                                    <mat-icon>close</mat-icon>
                                </button>
                            </div>
                        }
                        <form
                            class="search-form"
                            [formGroup]="searchForm"
                            (ngSubmit)="handleLookupSubmit()"
                            novalidate
                        >
                            <div class="category-section">
                                <mat-radio-group
                                    formControlName="category"
                                    class="category-options"
                                >
                                    @for (option of searchCategories; track option.value) {
                                        <mat-radio-button
                                            class="category-option"
                                            [value]="option.value"
                                            [disabled]="option.disabled"
                                        >
                                            <span class="category-label">{{ option.label }}</span>
                                            <span class="category-description">{{
                                                option.description
                                            }}</span>
                                        </mat-radio-button>
                                    }
                                </mat-radio-group>
                            </div>

                            <div class="search-field">
                                <h3>{{ activeCategory().inputLabel }}</h3>
                                <mat-form-field appearance="outline" class="search-input">
                                    <mat-label>{{ activeCategory().placeholder }}</mat-label>
                                    <input
                                        matInput
                                        formControlName="query"
                                        [placeholder]="activeCategory().placeholder"
                                        autocomplete="off"
                                    />
                                    @if (searchForm.get('query')?.value) {
                                        <button
                                            mat-icon-button
                                            matSuffix
                                            type="button"
                                            aria-label="Clear search"
                                            (click)="searchForm.get('query')?.reset('')"
                                        >
                                            <mat-icon>close</mat-icon>
                                        </button>
                                    }
                                    <mat-hint
                                        >At least three characters; ISBN searches work best with
                                        numbers only.</mat-hint
                                    >
                                    @if (searchForm.get('query')?.hasError('required')) {
                                        <mat-error> Enter an ISBN or keyword. </mat-error>
                                    }
                                    @if (searchForm.get('query')?.hasError('minlength')) {
                                        <mat-error> Use at least three characters. </mat-error>
                                    }
                                </mat-form-field>
                                <div class="search-actions">
                                    <button
                                        mat-flat-button
                                        color="primary"
                                        type="submit"
                                        [disabled]="lookupBusy() || searchForm.invalid"
                                    >
                                        @if (!lookupBusy()) {
                                            <span class="button-label">Search</span>
                                        }
                                        @if (lookupBusy()) {
                                            <mat-progress-spinner
                                                mode="indeterminate"
                                                diameter="18"
                                            ></mat-progress-spinner>
                                        }
                                    </button>
                                    @if (activeCategory().value === 'book') {
                                        <button
                                            mat-stroked-button
                                            type="button"
                                            (click)="
                                                scannerActive()
                                                    ? stopBarcodeScanner()
                                                    : startBarcodeScan()
                                            "
                                            [disabled]="lookupBusy()"
                                        >
                                            <mat-icon aria-hidden="true">photo_camera</mat-icon>
                                            @if (!scannerActive()) {
                                                <span>Scan barcode</span>
                                            }
                                            @if (scannerActive()) {
                                                <span>Stop scanning</span>
                                            }
                                        </button>
                                    }
                                </div>
                                @if (activeCategory().value === 'book') {
                                    <app-barcode-scanner
                                        #barcodeScanner
                                        [scannerActive]="scannerActive()"
                                        [scannerReady]="scannerReady()"
                                        [scannerStatus]="scannerStatus()"
                                        [scannerError]="scannerError()"
                                        [scannerProcessing]="scannerProcessing()"
                                        [scannerFlash]="scannerFlash()"
                                    ></app-barcode-scanner>
                                }
                            </div>
                        </form>

                        @if (lookupError() || lastLookupSummary()) {
                            <div class="lookup-feedback">
                                @if (lookupError()) {
                                    <div class="error">{{ lookupError() }}</div>
                                }
                                @if (!lookupError() && lastLookupSummary()) {
                                    <div class="success">
                                        {{ lastLookupSummary() }}
                                    </div>
                                }
                            </div>
                        }

                        <app-lookup-results
                            [results]="lookupResults()"
                            [busy]="busy()"
                            (quickAdd)="handleQuickAdd($event)"
                            (useForManual)="handleUseForManual($event)"
                        ></app-lookup-results>
                    </div>
                </mat-tab>
                <mat-tab label="Manual Entry">
                    <div class="tab-body manual-entry">
                        <div class="manual-entry-header">
                            <div>
                                <h3>Manual entry</h3>
                                <p>
                                    Fill in each field and save to add the item to your collection.
                                </p>
                            </div>
                            @if (manualDraftSource()) {
                                <button
                                    mat-stroked-button
                                    type="button"
                                    (click)="clearManualDraft()"
                                >
                                    Start fresh
                                </button>
                            }
                        </div>

                        @if (manualDraftSource(); as source) {
                            <div class="lookup-summary">
                                <mat-icon aria-hidden="true">check_circle</mat-icon>
                                <span>
                                    Pre-filled from {{ source.label }} search for “{{
                                        source.query
                                    }}”. Update anything before saving.
                                </span>
                            </div>
                        }

                        <app-item-form
                            [item]="null"
                            [draft]="manualDraft()"
                            mode="create"
                            [busy]="busy()"
                            (save)="handleSave($event)"
                            (cancelled)="handleCancel()"
                        ></app-item-form>
                    </div>
                </mat-tab>
                <mat-tab label="CSV Import">
                    <div class="tab-body">
                        <app-csv-import
                            #csvImport
                            [csvFields]="csvFields"
                            [csvTemplateUrl]="csvTemplateUrl"
                            [importBusy]="importBusy()"
                            [importSummary]="importSummary()"
                            [importError]="importError()"
                            (fileSelected)="handleCsvFileSelected($event)"
                            (importSubmit)="handleCsvImportSubmit()"
                            (cleared)="handleImportReset()"
                        ></app-csv-import>
                    </div>
                </mat-tab>
            </mat-tab-group>
        </mat-card-content>
    </mat-card>
</section>
