<section class="add-item-page">
    <mat-card>
        <mat-card-header>
            <mat-card-title>Add a new item</mat-card-title>
            <mat-card-subtitle>Search for metadata or enter details manually.</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            <mat-tab-group [selectedIndex]="selectedTab()" (selectedIndexChange)="handleTabChange($event)">
                <mat-tab label="Search">
                    <div class="tab-body search-tab">
                        <form class="search-form" [formGroup]="searchForm" (ngSubmit)="handleLookupSubmit()" novalidate>
                            <div class="category-section">
                                <mat-radio-group formControlName="category" class="category-options">
                                    <mat-radio-button
                                        class="category-option"
                                        *ngFor="let option of searchCategories"
                                        [value]="option.value"
                                        [disabled]="option.disabled"
                                    >
                                        <span class="category-label">{{ option.label }}</span>
                                        <span class="category-description">{{ option.description }}</span>
                                    </mat-radio-button>
                                </mat-radio-group>
                            </div>

                            <div class="search-field">
                                <h3>{{ activeCategory().inputLabel }}</h3>
                                <mat-form-field appearance="outline" class="search-input">
                                    <mat-label>{{ activeCategory().placeholder }}</mat-label>
                                    <input
                                        matInput
                                        formControlName="query"
                                        [placeholder]="activeCategory().placeholder"
                                        autocomplete="off"
                                    />
                                    <button
                                        mat-icon-button
                                        matSuffix
                                        type="button"
                                        aria-label="Clear search"
                                        *ngIf="searchForm.get('query')?.value"
                                        (click)="searchForm.get('query')?.reset('')"
                                    >
                                        <mat-icon>close</mat-icon>
                                    </button>
                                    <mat-hint>At least three characters; ISBN searches work best with numbers only.</mat-hint>
                                    <mat-error *ngIf="searchForm.get('query')?.hasError('required')">
                                        Enter an ISBN or keyword.
                                    </mat-error>
                                    <mat-error *ngIf="searchForm.get('query')?.hasError('minlength')">
                                        Use at least three characters.
                                    </mat-error>
                                </mat-form-field>
                                <div class="search-actions">
                                    <button
                                        mat-flat-button
                                        color="primary"
                                        type="submit"
                                        [disabled]="lookupBusy() || searchForm.invalid"
                                    >
                                        <span class="button-label" *ngIf="!lookupBusy()">Search</span>
                                        <mat-progress-spinner
                                            *ngIf="lookupBusy()"
                                            mode="indeterminate"
                                            diameter="18"
                                        ></mat-progress-spinner>
                                    </button>
                                    <button
                                        mat-stroked-button
                                        type="button"
                                        *ngIf="activeCategory().value === 'book'"
                                        (click)="scannerActive() ? stopBarcodeScanner() : startBarcodeScan()"
                                        [disabled]="lookupBusy()"
                                    >
                                        <mat-icon aria-hidden="true">photo_camera</mat-icon>
                                        <span *ngIf="!scannerActive()">Scan barcode</span>
                                        <span *ngIf="scannerActive()">Stop scanning</span>
                                    </button>
                                </div>
                                <div
                                    class="scanner-feedback"
                                    *ngIf="activeCategory().value === 'book' && (scannerStatus() || scannerError())"
                                >
                                    <div class="status" *ngIf="scannerStatus()">{{ scannerStatus() }}</div>
                                    <div class="error" *ngIf="scannerError()">{{ scannerError() }}</div>
                                </div>
                                <div
                                    class="scanner-preview"
                                    [class.scanner-preview--visible]="scannerActive()"
                                    [attr.aria-hidden]="scannerActive() ? 'false' : 'true'"
                                >
                                    <div class="video-frame">
                                        <video #scanVideo autoplay playsinline muted></video>
                                        <div class="overlay" *ngIf="scannerActive() && scannerStatus()?.includes('Align')">
                                            <div class="scanner-frame"></div>
                                        </div>
                                    </div>
                                    <p class="hint" *ngIf="scannerActive()">
                                        Once we read a code, we'll automatically run the lookup for you.
                                    </p>
                                </div>
                            </div>
                        </form>

                        <div class="lookup-feedback" *ngIf="lookupError() || lastLookupSummary()">
                            <div class="error" *ngIf="lookupError()">{{ lookupError() }}</div>
                            <div class="success" *ngIf="!lookupError() && lastLookupSummary()">{{ lastLookupSummary() }}</div>
                        </div>

                        <div class="lookup-preview" *ngIf="lookupResults().length">
<div class="preview-header">
<h3>Metadata preview</h3>
<p>
Review the fetched details, then choose the best match to add immediately or continue editing
from the Manual Entry tab.
</p>
</div>

<div class="preview-list">
<article class="preview-card" *ngFor="let preview of lookupResults()">
<div class="preview-grid">
<div class="preview-field">
<span class="label">Title</span>
<span class="value">{{ preview.title || '—' }}</span>
</div>
<div class="preview-field">
<span class="label">Creator</span>
<span class="value">{{ preview.creator || '—' }}</span>
</div>
<div class="preview-field">
<span class="label">Release year</span>
<span class="value">{{ preview.releaseYear ?? '—' }}</span>
</div>
<div class="preview-field">
<span class="label">Number of pages</span>
<span class="value">{{ preview.pageCount ?? '—' }}</span>
</div>
<div class="preview-field">
<span class="label">EAN / ISBN13</span>
<span class="value">{{ preview.isbn13 || '—' }}</span>
</div>
<div class="preview-field">
<span class="label">ISBN-10</span>
<span class="value">{{ preview.isbn10 || '—' }}</span>
</div>
</div>

<div class="preview-description" *ngIf="preview.description">
<h4>Description</h4>
<p>{{ preview.description }}</p>
</div>

<div class="preview-actions">
<button
mat-flat-button
color="primary"
type="button"
class="preview-add"
(click)="handleQuickAdd(preview)"
[disabled]="busy()"
>
Add to collection
</button>
<button
mat-stroked-button
type="button"
(click)="handleUseForManual(preview)"
>
Use for manual entry
</button>
</div>
</article>
</div>
</div>
                    </div>
                </mat-tab>
                <mat-tab label="Manual Entry">
                    <div class="tab-body manual-entry">
                        <div class="manual-entry-header">
                            <div>
                                <h3>Manual entry</h3>
                                <p>Fill in each field and save to add the item to your collection.</p>
                            </div>
                            <button
                                mat-stroked-button
                                type="button"
                                (click)="clearManualDraft()"
                                *ngIf="manualDraftSource()"
                            >
                                Start fresh
                            </button>
                        </div>

                        <div class="lookup-summary" *ngIf="manualDraftSource() as source">
                            <mat-icon aria-hidden="true">check_circle</mat-icon>
                            <span>
                                Pre-filled from {{ source.label }} search for “{{ source.query }}”. Update anything before
                                saving.
                            </span>
                        </div>

                        <app-item-form
                            [item]="null"
                            [draft]="manualDraft()"
                            mode="create"
                            [busy]="busy()"
                            (save)="handleSave($event)"
                            (cancelled)="handleCancel()"
                        ></app-item-form>
                    </div>
                </mat-tab>
                <mat-tab label="CSV Import">
                    <div class="tab-body csv-tab">
                        <div class="csv-header">
                            <div>
                                <h3>Bulk import</h3>
                                <p>Upload the Anthology CSV template to add multiple items at once.</p>
                            </div>
                        </div>

                        <div class="csv-instructions">
                            <h4>Required columns</h4>
                            <p>
                                Make sure your CSV includes this header row. Keep the column names lowercase to
                                avoid validation errors.
                            </p>
                            <div class="field-list">
                                <span class="field" *ngFor="let field of csvFields">{{ field }}</span>
                            </div>
                            <p class="hint">
                                For books, you can leave the title blank if you include an ISBN. We'll fetch the
                                metadata automatically. Use the <code>coverImage</code> column for an HTTPS image URL (or
                                leave it blank to add one later). Duplicate titles or ISBNs are skipped and reported below.
                            </p>
                        </div>

                        <form class="csv-form" (ngSubmit)="handleImportSubmit($event)" novalidate>
                            <label class="file-input">
                                <span class="label">CSV file</span>
                                <input
                                    #csvInput
                                    type="file"
                                    accept=".csv,text/csv"
                                    (change)="handleCsvFileChange($event)"
                                    [disabled]="importBusy()"
                                />
                                <div class="file-meta" *ngIf="selectedCsvFile() as file">
                                    <mat-icon aria-hidden="true">attach_file</mat-icon>
                                    <span>{{ file.name }}</span>
                                </div>
                            </label>
                            <div class="csv-actions">
                                <button
                                    mat-flat-button
                                    color="primary"
                                    type="button"
                                    [disabled]="!selectedCsvFile() || importBusy()"
                                    (click)="handleImportSubmit($event)"
                                >
                                    <span *ngIf="!importBusy()">Upload CSV</span>
                                    <mat-progress-spinner
                                        *ngIf="importBusy()"
                                        diameter="18"
                                        mode="indeterminate"
                                    ></mat-progress-spinner>
                                </button>
                                <button
                                    mat-stroked-button
                                    type="button"
                                    (click)="handleImportReset()"
                                    [disabled]="importBusy() || (!selectedCsvFile() && !importSummary())"
                                >
                                    Clear
                                </button>
                                <a
                                    class="csv-template-link"
                                    [href]="csvTemplateUrl"
                                    download="anthology-import-template.csv"
                                >
                                    <mat-icon aria-hidden="true">file_download</mat-icon>
                                    <span>Download template</span>
                                </a>
                            </div>
                        </form>

                        <div class="csv-summary" *ngIf="importSummary() as summary">
                            <h4>Import summary</h4>
                            <p>Imported {{ summary.imported }} of {{ summary.totalRows }} rows.</p>

                            <div class="summary-section" *ngIf="summary.skippedDuplicates.length">
                                <h5>Skipped duplicates</h5>
                                <ul>
                                    <li *ngFor="let entry of summary.skippedDuplicates">
                                        Row {{ entry.row }} ·
                                        {{ entry.title || entry.identifier || 'Untitled item' }} — {{ entry.reason }}
                                    </li>
                                </ul>
                            </div>

                            <div class="summary-section" *ngIf="summary.failed.length">
                                <h5>Rows with errors</h5>
                                <ul>
                                    <li *ngFor="let entry of summary.failed">
                                        Row {{ entry.row }} · {{ entry.title || entry.identifier || 'Untitled item' }}:
                                        {{ entry.error }}
                                    </li>
                                </ul>
                            </div>
                        </div>
                   </div>
               </mat-tab>
            </mat-tab-group>
        </mat-card-content>
    </mat-card>
</section>
