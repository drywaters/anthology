<div class="csv-import">
    <div class="csv-header">
        <div>
            <h3>Bulk import</h3>
            <p>Upload the Anthology CSV template to add multiple items at once.</p>
        </div>
    </div>

    <div class="csv-instructions">
        <h4>Required columns</h4>
        <p>
            Make sure your CSV includes this header row. Keep the column names lowercase to avoid
            validation errors.
        </p>
        <div class="field-list">
            @for (field of csvFields; track field) {
                <span class="field">{{ field }}</span>
            }
        </div>
        <p class="hint">
            For books, you can leave the title blank if you include an ISBN. We'll fetch the
            metadata automatically. Use the <code>coverImage</code> column for an HTTPS image URL
            (or leave it blank to add one later). Duplicate titles or ISBNs are skipped and reported
            below.
        </p>
    </div>

    <form class="csv-form" (ngSubmit)="handleSubmit($event)" novalidate>
        <label class="file-input">
            <span class="label">CSV file</span>
            <input
                #csvInput
                type="file"
                accept=".csv,text/csv"
                (change)="handleFileChange($event)"
                [disabled]="importBusy"
            />
            @if (selectedFile(); as file) {
                <div class="file-meta">
                    <mat-icon aria-hidden="true">attach_file</mat-icon>
                    <span>{{ file.name }}</span>
                </div>
            }
        </label>
        <div class="csv-actions">
            <button
                mat-flat-button
                color="primary"
                type="button"
                [disabled]="!selectedFile() || importBusy"
                (click)="handleSubmit($event)"
            >
                @if (!importBusy) {
                    <span>Upload CSV</span>
                }
                @if (importBusy) {
                    <mat-progress-spinner diameter="18" mode="indeterminate"></mat-progress-spinner>
                }
            </button>
            <button
                mat-stroked-button
                type="button"
                (click)="handleReset()"
                [disabled]="importBusy || (!selectedFile() && !importSummary)"
            >
                Clear
            </button>
            <a
                class="csv-template-link"
                [href]="csvTemplateUrl"
                download="anthology-import-template.csv"
            >
                <mat-icon aria-hidden="true">file_download</mat-icon>
                <span>Download template</span>
            </a>
        </div>
    </form>

    @if (importError) {
        <div class="csv-feedback">
            <mat-icon aria-hidden="true">error</mat-icon>
            <span>{{ importError }}</span>
        </div>
    }

    @if (importSummary; as summary) {
        <div class="csv-summary">
            <h4>Import summary</h4>
            <p>Imported {{ summary.imported }} of {{ summary.totalRows }} rows.</p>
            @if (summary.skippedDuplicates.length) {
                <div class="summary-section">
                    <h5>Skipped duplicates</h5>
                    <ul>
                        @for (entry of summary.skippedDuplicates; track entry) {
                            <li>
                                Row {{ entry.row }} ·
                                {{ entry.title || entry.identifier || 'Untitled item' }} —
                                {{ entry.reason }}
                            </li>
                        }
                    </ul>
                </div>
            }
            @if (summary.failed.length) {
                <div class="summary-section">
                    <h5>Rows with errors</h5>
                    <ul>
                        @for (entry of summary.failed; track entry) {
                            <li>
                                Row {{ entry.row }} ·
                                {{ entry.title || entry.identifier || 'Untitled item' }}:
                                {{ entry.error }}
                            </li>
                        }
                    </ul>
                </div>
            }
        </div>
    }
</div>
