<div class="page">
    <div class="filters-panel">
        <div class="filters">
            <mat-form-field appearance="outline" class="type-select">
                <mat-label>Type</mat-label>
                <mat-select [value]="typeFilter()" (valueChange)="setTypeFilter($event)">
                    <mat-option *ngFor="let option of typeOptions" [value]="option.value">
                        {{ option.label }}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <div class="letter-filter" role="list">
                <button
                    mat-button
                    type="button"
                    class="letter-button"
                    [class.active]="letterFilter() === 'ALL'"
                    (click)="setLetterFilter('ALL')"
                >
                    All
                </button>
                <button
                    mat-button
                    type="button"
                    class="letter-button"
                    *ngFor="let letter of alphabet"
                    [class.active]="letterFilter() === letter"
                    (click)="setLetterFilter(letter)"
                >
                    {{ letter }}
                </button>
            </div>

            <div class="view-toggle" role="group" aria-label="Change view">
                <button
                    mat-icon-button
                    type="button"
                    [class.active]="!isGridView()"
                    (click)="setViewMode('table')"
                    aria-label="Switch to list view"
                    [attr.aria-pressed]="!isGridView()"
                >
                    <mat-icon>list</mat-icon>
                </button>
                <button
                    mat-icon-button
                    type="button"
                    [class.active]="isGridView()"
                    (click)="setViewMode('grid')"
                    aria-label="Switch to grid view"
                    [attr.aria-pressed]="isGridView()"
                >
                    <mat-icon>grid_view</mat-icon>
                </button>
            </div>
        </div>
    </div>
    <div class="layout">
        <section class="items-panel">
            <mat-card>
                <mat-progress-bar *ngIf="loading()" mode="indeterminate"></mat-progress-bar>

                <ng-container *ngIf="isGridView(); else tableView">
                    <ng-container *ngIf="hasFilteredItems(); else filteredFallback">
                        <div class="card-grid" data-testid="item-card-grid">
                            <article
                                class="item-card"
                                *ngFor="let item of items(); trackBy: trackById"
                                (click)="startEdit(item)"
                                tabindex="0"
                                (keydown)="handleCardKeydown($event, item)"
                            >
                                <div class="card-cover" [class.card-cover--empty]="!item.coverImage">
                                    <img *ngIf="item.coverImage" [src]="item.coverImage" [alt]="item.title + ' cover'" />
                                    <div *ngIf="!item.coverImage" class="card-cover-placeholder">
                                        <mat-icon aria-hidden="true">book</mat-icon>
                                        <span>Tap to edit</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="card-title-row">
                                        <h4>{{ item.title }}</h4>
                                        <span class="card-chip item-type-chip" [ngClass]="chipClassFor(item.itemType)">
                                            {{ labelFor(item) }}
                                        </span>
                                    </div>
                                    <p class="card-meta">{{ item.creator || 'Unknown creator' }}</p>
                                    <p class="card-sub" *ngIf="item.releaseYear">Released {{ item.releaseYear }}</p>
                                </div>
                            </article>
                        </div>
                    </ng-container>
                </ng-container>

                <ng-template #tableView>
                    <ng-container *ngIf="hasFilteredItems(); else filteredFallback">
                        <div class="table-wrapper">
                            <table
                                mat-table
                                [dataSource]="items()"
                                [trackBy]="trackById"
                                class="items-table"
                                data-testid="items-table"
                            >
                                <ng-container matColumnDef="title">
                                    <th mat-header-cell *matHeaderCellDef>Title</th>
                                    <td mat-cell *matCellDef="let item">
                                        <div class="item-title">{{ item.title }}</div>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="creator">
                                    <th mat-header-cell *matHeaderCellDef>Creator</th>
                                    <td mat-cell *matCellDef="let item">{{ item.creator || '—' }}</td>
                                </ng-container>

                                <ng-container matColumnDef="itemType">
                                    <th mat-header-cell *matHeaderCellDef>Type</th>
                                    <td mat-cell *matCellDef="let item">
                                        <button
                                            type="button"
                                            class="item-type-chip"
                                            [ngClass]="chipClassFor(item.itemType)"
                                            (click)="filterByType(item.itemType); $event.stopPropagation()"
                                            [attr.aria-label]="'Filter by ' + labelFor(item)"
                                            [attr.aria-pressed]="typeFilter() === item.itemType"
                                        >
                                            {{ labelFor(item) }}
                                        </button>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="releaseYear">
                                    <th mat-header-cell *matHeaderCellDef>Released</th>
                                    <td mat-cell *matCellDef="let item">{{ item.releaseYear || '—' }}</td>
                                </ng-container>

                                <ng-container matColumnDef="updatedAt">
                                    <th mat-header-cell *matHeaderCellDef>Last updated</th>
                                    <td mat-cell *matCellDef="let item">{{ item.updatedAt | date: 'mediumDate' }}</td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                                <tr
                                    mat-row
                                    *matRowDef="let row; columns: displayedColumns"
                                    class="clickable-row"
                                    tabindex="0"
                                    (click)="startEdit(row)"
                                    (keydown.enter)="startEdit(row)"
                                    (keydown.space)="startEdit(row); $event.preventDefault()"
                                ></tr>
                            </table>
                        </div>
                    </ng-container>
                </ng-template>

                <ng-template #filteredFallback>
                    <ng-container *ngIf="isUnfiltered(); else noResults">
                        <ng-container *ngTemplateOutlet="emptyState"></ng-container>
                    </ng-container>
                </ng-template>

                <ng-template #emptyState>
                    <div class="empty-state" *ngIf="!loading()">
                        <mat-icon>auto_stories</mat-icon>
                        <h3>Curate your first shelf</h3>
                        <p>
                            Capture the favorites you already love. Start with a few hallmark picks to shape your signature shelf.
                        </p>
                        <button mat-stroked-button color="accent" (click)="startCreate()">Create an entry</button>
                    </div>
                </ng-template>
                <ng-template #noResults>
                    <div class="no-results" *ngIf="!loading()">No items match your filters.</div>
                </ng-template>
            </mat-card>
        </section>

    </div>
</div>
