<div class="table-wrapper">
    <ng-container *ngFor="let group of groupedItems(); trackBy: trackByLetter">
        <section class="letter-section" [attr.data-letter]="group.letter">
            <h4 class="letter-header">{{ group.letter }}</h4>
            <table
                mat-table
                [dataSource]="group.items"
                [trackBy]="trackById"
                class="items-table"
                data-testid="items-table"
            >
                <colgroup>
                    <col class="col-title" />
                    <col class="col-creator" />
                    <col class="col-itemType" />
                    <col class="col-releaseYear" />
                    <col class="col-updatedAt" />
                </colgroup>

                <ng-container matColumnDef="title">
                    <th mat-header-cell *matHeaderCellDef>Title</th>
                    <td mat-cell *matCellDef="let item">
                        <div class="item-title-row">
                            <div class="item-title">{{ item.title }}</div>
                            <button
                                *ngIf="item.shelfPlacement"
                                mat-icon-button
                                type="button"
                                class="shelf-location-button"
                                (click)="onShelfLocationRequested(item, $event)"
                                [attr.aria-label]="
                                    'View shelf slot ' +
                                    (item.shelfPlacement.rowIndex + 1) +
                                    '/' +
                                    (item.shelfPlacement.colIndex + 1) +
                                    ' on ' +
                                    item.shelfPlacement.shelfName
                                "
                            >
                                <mat-icon aria-hidden="true">visibility</mat-icon>
                            </button>
                            <button
                                *ngIf="item.seriesName"
                                mat-icon-button
                                type="button"
                                class="series-button"
                                (click)="onSeriesRequested(item, $event)"
                                [attr.aria-label]="'View series: ' + item.seriesName"
                            >
                                <mat-icon aria-hidden="true">collections_bookmark</mat-icon>
                            </button>
                        </div>
                        <div class="item-subtext" *ngIf="readingProgress(item) as progress">
                            Reading •
                            <ng-container
                                *ngIf="progress.percent !== undefined; else tableProgressFallback"
                            >
                                {{ progress.percent }}% complete ({{ progress.current }}/{{
                                    progress.total
                                }}
                                pages)
                            </ng-container>
                            <ng-template #tableProgressFallback
                                >On page {{ progress.current }}</ng-template
                            >
                        </div>
                    </td>
                </ng-container>

                <ng-container matColumnDef="creator">
                    <th mat-header-cell *matHeaderCellDef>Creator</th>
                    <td mat-cell *matCellDef="let item">
                        {{ item.creator || '—' }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="itemType">
                    <th mat-header-cell *matHeaderCellDef>Type</th>
                    <td mat-cell *matCellDef="let item">
                        <button
                            type="button"
                            class="item-type-chip"
                            [ngClass]="chipClassFor(item.itemType)"
                            (click)="onTypeFilterRequested(item.itemType, $event)"
                            [attr.aria-label]="'Filter by ' + labelFor(item)"
                            [attr.aria-pressed]="typeFilter() === item.itemType"
                        >
                            {{ labelFor(item) }}
                        </button>
                    </td>
                </ng-container>

                <ng-container matColumnDef="releaseYear">
                    <th mat-header-cell *matHeaderCellDef>Released</th>
                    <td mat-cell *matCellDef="let item">
                        {{ item.releaseYear || '—' }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="updatedAt">
                    <th mat-header-cell *matHeaderCellDef>Last updated</th>
                    <td mat-cell *matCellDef="let item">
                        {{ item.updatedAt | date: 'mediumDate' }}
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns" class="sr-only"></tr>
                <tr
                    mat-row
                    *matRowDef="let row; columns: displayedColumns"
                    class="clickable-row"
                    tabindex="0"
                    (click)="onItemSelected(row)"
                    (keydown)="handleRowKeydown($event, row)"
                ></tr>
            </table>
        </section>
    </ng-container>
</div>
